{% load static %}
<html>
<head>
    <title>User List</title>
    <style>
        .container {
            width: 100%;
            max-width: 500px;
            margin: 50px auto;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            padding: 15px;
            background-color: #4caf50;
            color: white;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .user-list {
            margin: 0;
            gap: 1rem;
            padding: 0;
            display: flex;
            list-style: none;
            align-items: center;
            flex-direction: column;
        }
        .user-list li {
            width: 80%;
            text-align: center;
            color: black;
            border-radius: 3rem;
            background: #f0f0f0;
            padding: 1.1rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
        }
        .user-list li:hover {
            background: #e0e0e0;
        }
    </style>
</head>
<body>
<div class="container">
    <header class="chat-header">Users</header>
    <ul class="user-list" id="userList">
        {% for user in users %}
            <li id="user-{{ user.username }}" onclick="startChat('{{ user.username }}')">
    {{ user.username }}
    <span class="user-status" data-username="{{ user.username }}">
        {% if user.status.is_online %}
            <span style="color: green;">Online</span>
        {% else %}
            <span style="color: red;"></span>
        {% endif %}
    </span>
</li>
        {% endfor %}
    </ul>
</div>

<script>

const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    function connectSocket() {
        const socket = new WebSocket(wsProtocol + window.location.host + '/ws/status/');

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updateUserStatus(data.username, data.is_online);
        };
        socket.onclose = function(event) {
            console.error('Status socket closed unexpectedly. Reconnecting in 5 seconds...');
            setTimeout(connectSocket, 5000);
        };
    }
    connectSocket();
function updateUserStatus(username, isOnline) {
    const userElement = document.getElementById(`user-${username}`);
    if (userElement) {
        const statusElement = userElement.querySelector('.user-status span');
        if (statusElement) {
                statusElement.textContent = isOnline ? 'Online' : 'Offline';
                statusElement.style.color = isOnline ? 'green' : 'red';
            }
    } else {
        console.log(`User element for ${username} not found`);
    }
}

function startChat(username) {
    window.location.href = '/chat/' + username + '/';
}

const notificationSocket = new WebSocket('ws://' + window.location.host + '/ws/notifications/');

    notificationSocket.onmessage = event => {
        const data = JSON.parse(event.data);
        if (data.type === 'notification') {
            alert(`New message from ${data.sender}: ${data.message}`);
        }
    };

    notificationSocket.onclose = event => {
        console.error('Notification socket closed unexpectedly');
    };
</script>
</body>
</html>
